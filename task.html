<!DOCTYPE html>
<html lang="bn">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Tasks | VIP User</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
<style>
body{font-family:'Poppins',sans-serif;background:#0b1228;color:#fff;margin:0;padding-bottom:70px;}
.header{display:flex;align-items:center;gap:10px;background:#101936;padding:15px;color:#fff;position:relative;}
.header i{cursor:pointer;color:#fbbf24;font-size:20px;}
.header h2{margin:0;font-size:20px;}
.container{max-width:900px;margin:20px auto;padding:10px;}
.card{background:#1b2550;padding:15px;border-radius:12px;margin-bottom:15px;box-shadow:0 0 10px rgba(0,0,0,0.3);}
.card h3{color:#fbbf24;margin:0 0 5px 0;}
.card p{font-size:14px;color:#ccc;}
.card h5{color:#9ca3af;margin:5px 0;}
.card small{color:#9ca3af;display:block;margin-bottom:5px;}
.card button{background:#fbbf24;color:#000;border:none;padding:7px 14px;border-radius:8px;cursor:pointer;margin-top:8px;}
.card button:hover{background:#ffda7a;}
.no-task{display:flex;justify-content:center;align-items:center;margin-top:50px;}
.no-task img{max-width:300px;opacity:0.7;}
.message{background:#1b2550;padding:15px;border-radius:12px;text-align:center;margin-top:20px;color:#fbbf24;}
</style>
</head>
<body>

<div class="header">
  <i class="fas fa-arrow-left" onclick="window.location.href='admin.html'"></i>
  <h2>Available Tasks</h2>
</div>

<div class="container" id="taskList">Loading tasks...</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.3.0/firebase-app.js";
import { getDatabase, ref, get } from "https://www.gstatic.com/firebasejs/10.3.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyApIiGovH14024loNQMVTsm_qE3H2Fa658",
  authDomain: "eshopingbddd.firebaseapp.com",
  databaseURL: "https://eshopingbddd-default-rtdb.firebaseio.com",
  projectId: "eshopingbddd",
  storageBucket: "eshopingbddd.appspot.com",
  messagingSenderId: "19777305233",
  appId: "1:19777305233:web:33f3871db06beeaf129d30"
};
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

const uid = localStorage.getItem('uid');
const taskList = document.getElementById('taskList');

async function loadTasks(){
  if(!uid){ taskList.innerHTML='<p class="message">User not found. Please login first.</p>'; return; }

  const userSnap = await get(ref(db,'users/'+uid));
  const user = userSnap.val();
  
  if(!user || !user.verified){
    taskList.innerHTML='<p class="message">First verify your account to access tasks.</p>';
    return;
  }

  const tasksSnap = await get(ref(db,'tasks'));
  const tasks = tasksSnap.val() || {};

  const submissionsSnap = await get(ref(db,'submissions'));
  const submissions = submissionsSnap.val() || {};

  taskList.innerHTML='';
  let hasTask = false;
  Object.keys(tasks).reverse().forEach(taskId=>{
    const t = tasks[taskId];

    // User done count
    let userDone = 0;
    let totalDone = 0;
    Object.values(submissions).forEach(s=>{
      if(s.taskId===taskId) totalDone++;
      if(s.taskId===taskId && s.uid===uid) userDone++;
    });

    if(t.maxAttempts && userDone>=t.maxAttempts) return; // hide task if max done

    hasTask = true;
    taskList.innerHTML += `
      <div class="card">
        <h3>${t.title}</h3>
        <p>${t.desc}</p>
        <h5>Reward: ${t.reward} coins</h5>
        <small>Your Completed: ${userDone}/${t.maxAttempts || ''}</small>
        <small>People Completed: ${totalDone}</small>
        <button onclick="startTask('${taskId}')">Start Task</button>
      </div>
    `;
  });

  if(!hasTask){
    taskList.innerHTML = `
      <div class="no-task">
        <img src="https://i.ibb.co/5WvY8xC/no-task.png" alt="No Task Available">
      </div>
    `;
  }
}

window.startTask = (taskId)=>{
  window.location.href=`taskstart.html?taskId=${taskId}`;
}

loadTasks();
</script>

</body>
</html>